<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration de la Galerie - Kiks Travel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gallery-item {
            margin-bottom: 30px;
        }
        .gallery-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .image-container {
            position: relative;
            aspect-ratio: 1;
        }
        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #uploadPreview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        #uploadPreview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row mb-4">
            <div class="col">
                <h1>Administration de la Galerie</h1>
                <p>Gérez les galeries Kiks Travel</p>
            </div>
        </div>

        <!-- Formulaire d'authentification -->
        <div id="authForm" class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Authentification</h5>
                        <div class="mb-3">
                            <label for="adminKey" class="form-label">Clé d'administration</label>
                            <input type="password" class="form-control" id="adminKey" placeholder="Entrez votre clé d'administration">
                        </div>
                        <button class="btn btn-primary" onclick="authenticate()">Se connecter</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section principale (cachée jusqu'à l'authentification) -->
        <div id="mainContent" style="display: none;">
            <!-- Formulaire d'ajout -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Ajouter une galerie</h5>
                            <form id="uploadForm" onsubmit="return false;">
                                <div class="mb-3">
                                    <label for="title" class="form-label">Titre de la galerie</label>
                                    <input type="text" class="form-control" id="title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" rows="3" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="images" class="form-label">Images</label>
                                    <input type="file" class="form-control" id="images" accept="image/*" multiple required onchange="previewImages(event)">
                                </div>
                                <div id="uploadPreview" class="mb-3"></div>
                                <button class="btn btn-primary" onclick="uploadGallery()">Créer la galerie</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Galeries -->
            <div id="galleryContainer">
                <!-- Les galeries seront ajoutées ici dynamiquement -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let adminKey = '';

        function authenticate() {
            adminKey = document.getElementById('adminKey').value;
            if (!adminKey) {
                alert('Veuillez entrer une clé d\'administration');
                return;
            }
            loadGallery();
        }

        async function loadGallery() {
            try {
                const response = await fetch('/api/gallery');
                if (!response.ok) throw new Error('Erreur lors du chargement de la galerie');
                
                const galleries = await response.json();
                document.getElementById('authForm').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                const container = document.getElementById('galleryContainer');
                container.innerHTML = '';
                
                galleries.forEach(gallery => {
                    const div = document.createElement('div');
                    div.className = 'gallery-item card mb-4';
                    div.innerHTML = `
                        <div class="card-body">
                            <h3 class="card-title">${gallery.title}</h3>
                            <p class="card-text">${gallery.description}</p>
                            <div class="gallery-images">
                                ${gallery.images.map((image, index) => `
                                    <div class="image-container">
                                        <img src="${image}" alt="${gallery.title} - Image ${index + 1}">
                                        <button class="delete-btn" onclick="deleteImage(${gallery.id}, ${index})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-3">
                                <input type="file" class="form-control" id="addImages_${gallery.id}" multiple accept="image/*">
                                <button class="btn btn-secondary mt-2" onclick="addImagesToGallery(${gallery.id})">
                                    Ajouter des images
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement de la galerie');
            }
        }

        function previewImages(event) {
            const preview = document.getElementById('uploadPreview');
            preview.innerHTML = '';
            const files = event.target.files;

            for (const file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        }

        async function uploadGallery() {
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const imageFiles = document.getElementById('images').files;

            if (!title || !description || imageFiles.length === 0) {
                alert('Veuillez remplir tous les champs et sélectionner au moins une image');
                return;
            }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', description);
            for (const file of imageFiles) {
                formData.append('images', file);
            }

            try {
                const response = await fetch('/api/gallery', {
                    method: 'POST',
                    headers: {
                        'admin-key': adminKey
                    },
                    body: formData
                });

                if (!response.ok) throw new Error('Erreur lors de l\'upload');

                alert('Galerie créée avec succès');
                document.getElementById('uploadForm').reset();
                document.getElementById('uploadPreview').innerHTML = '';
                loadGallery();
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la création de la galerie');
            }
        }

        async function addImagesToGallery(galleryId) {
            const input = document.getElementById(`addImages_${galleryId}`);
            const files = input.files;

            if (files.length === 0) {
                alert('Veuillez sélectionner des images à ajouter');
                return;
            }

            const formData = new FormData();
            for (const file of files) {
                formData.append('images', file);
            }

            try {
                const response = await fetch(`/api/gallery/${galleryId}/images`, {
                    method: 'POST',
                    headers: {
                        'admin-key': adminKey
                    },
                    body: formData
                });

                if (!response.ok) throw new Error('Erreur lors de l\'ajout des images');

                alert('Images ajoutées avec succès');
                input.value = '';
                loadGallery();
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'ajout des images');
            }
        }

        async function deleteImage(galleryId, imageIndex) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette image ?')) return;

            try {
                const response = await fetch(`/api/gallery/${galleryId}/images/${imageIndex}`, {
                    method: 'DELETE',
                    headers: {
                        'admin-key': adminKey
                    }
                });

                if (!response.ok) throw new Error('Erreur lors de la suppression');

                alert('Image supprimée avec succès');
                loadGallery();
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la suppression de l\'image');
            }
        }
    </script>
</body>
</html>
