<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration de la Galerie - Kiks Travel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gallery-item {
            position: relative;
            margin-bottom: 20px;
        }
        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
        .gallery-item .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .gallery-item .info {
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        #uploadPreview {
            max-width: 300px;
            max-height: 200px;
            object-fit: contain;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row mb-4">
            <div class="col">
                <h1>Administration de la Galerie</h1>
                <p>Gérez les images de la galerie Kiks Travel</p>
            </div>
        </div>

        <!-- Formulaire d'authentification -->
        <div id="authForm" class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Authentification</h5>
                        <div class="mb-3">
                            <label for="adminKey" class="form-label">Clé d'administration</label>
                            <input type="password" class="form-control" id="adminKey" placeholder="Entrez votre clé d'administration">
                        </div>
                        <button class="btn btn-primary" onclick="authenticate()">Se connecter</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section principale (cachée jusqu'à l'authentification) -->
        <div id="mainContent" style="display: none;">
            <!-- Formulaire d'ajout -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Ajouter une image</h5>
                            <form id="uploadForm" onsubmit="return false;">
                                <div class="mb-3">
                                    <label for="title" class="form-label">Titre</label>
                                    <input type="text" class="form-control" id="title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" rows="3" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="image" class="form-label">Image</label>
                                    <input type="file" class="form-control" id="image" accept="image/*" required onchange="previewImage(event)">
                                </div>
                                <img id="uploadPreview" class="img-fluid" alt="Aperçu">
                                <button class="btn btn-primary" onclick="uploadImage()">Ajouter à la galerie</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Galerie -->
            <div class="row" id="galleryContainer">
                <!-- Les images seront ajoutées ici dynamiquement -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let adminKey = '';

        function authenticate() {
            adminKey = document.getElementById('adminKey').value;
            if (!adminKey) {
                alert('Veuillez entrer une clé d\'administration');
                return;
            }

            // Tester la clé en essayant de charger la galerie
            loadGallery();
        }

        async function loadGallery() {
            try {
                const response = await fetch('/api/gallery');
                if (!response.ok) throw new Error('Erreur lors du chargement de la galerie');
                
                const gallery = await response.json();
                document.getElementById('authForm').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                const container = document.getElementById('galleryContainer');
                container.innerHTML = '';
                
                gallery.forEach(item => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4 gallery-item';
                    col.innerHTML = `
                        <div class="position-relative">
                            <img src="${item.image}" alt="${item.title}" class="img-fluid">
                            <button class="delete-btn" onclick="deleteImage(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                            <div class="info">
                                <h5>${item.title}</h5>
                                <p>${item.description}</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                });
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement de la galerie');
            }
        }

        function previewImage(event) {
            const preview = document.getElementById('uploadPreview');
            const file = event.target.files[0];
            if (file) {
                preview.style.display = 'block';
                preview.src = URL.createObjectURL(file);
            }
        }

        async function uploadImage() {
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const imageFile = document.getElementById('image').files[0];

            if (!title || !description || !imageFile) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', description);
            formData.append('image', imageFile);

            try {
                const response = await fetch('/api/gallery', {
                    method: 'POST',
                    headers: {
                        'admin-key': adminKey
                    },
                    body: formData
                });

                if (!response.ok) throw new Error('Erreur lors de l\'upload');

                alert('Image ajoutée avec succès');
                document.getElementById('uploadForm').reset();
                document.getElementById('uploadPreview').style.display = 'none';
                loadGallery();
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'ajout de l\'image');
            }
        }

        async function deleteImage(id) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette image ?')) return;

            try {
                const response = await fetch(`/api/gallery/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'admin-key': adminKey
                    }
                });

                if (!response.ok) throw new Error('Erreur lors de la suppression');

                alert('Image supprimée avec succès');
                loadGallery();
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la suppression de l\'image');
            }
        }
    </script>
</body>
</html>
